# re-oil-production-llm

![image](https://github.com/user-attachments/assets/6883733b-126d-4529-9cd6-850a5e500a20)

## Использование LLM для оптимизации добычи нефти

Этот проект исследует применение больших языковых моделей (LLM) для оптимизации стратегий добычи нефти. Мы используем методы обучения с подкреплением, в частности GRPO, для обучения языковых моделей принимать оптимальные решения по управлению нефтяными скважинами.

## Обзор проекта

Оптимизация добычи нефти требует поиска баланса между немедленными темпами добычи и долгосрочным управлением резервуаром. В этом проекте реализовано:

- Среда симуляции для нефтяных скважин (как одиночных, так и многоскважинных сценариев)
- Обучающая платформа на основе GRPO для тонкой настройки LLM
- Методы инженерии промптов для управления ответами LLM
- Методы оценки для измерения эффективности оптимизации

Обученные модели учатся контролировать степень открытия штуцера (от 0 до 1), чтобы максимизировать общую добычу нефти за весь период симуляции.

## Особенности

- **Симуляции одиночных и многоскважинных систем**: Моделирование как автономных, так и взаимосвязанных систем скважин
- **Обучение с использованием GRPO**: Эффективная оптимизация политики для LLM
- **Случайные начальные состояния**: Поддержка обучения из случайных промежуточных состояний в жизненном цикле скважины
- **Инженерия промптов**: Структурированные форматы ввода для согласованных и эффективных ответов LLM
- **Интеграция с WandB и TensorBoard**: Комплексное отслеживание и визуализация экспериментов
- **Поддержка квантизации**: 4-битная и 8-битная квантизация для эффективного обучения моделей
- **Тонкая настройка с LoRA**: Low-Rank Adaptation для эффективной настройки параметров

## Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/researchim-ai/re-oil-production-llm.git
cd re-oil-production-llm
```

2. Установите необходимые зависимости:
```bash
pip install -r requirements.txt
```

## Использование

Для запуска обучения:

```bash
python -m grpo.main --forecast_days 1 --simulation_max_time 4 --kl_weight 0.0 --lr 1e-5 --clip_eps 0.3 --gamma 0.99 --total_steps 1000 --rollouts_per_step 8 --train_batch_size 8 --temperature 0.7 --wandb --use_discrete_actions
```

### Примеры команд

#### Базовое обучение
```bash
python -m grpo.main --forecast_days 1 --simulation_max_time 365 --kl_weight 0.02 --lr 1e-5 --total_steps 1000 --rollouts_per_step 16 --train_batch_size 8 --wandb
```

#### Обучение со случайными начальными состояниями
```bash
python -m grpo.main --forecast_days 1 --simulation_max_time 365 --kl_weight 0.02 --lr 1e-5 --total_steps 1000 --rollouts_per_step 16 --train_batch_size 8 --wandb --use_random_states --random_state_min_depletion 0.1 --random_state_max_depletion 0.7 --random_state_probability 0.8 --use_realistic_ranges
```

Параметры случайных начальных состояний:
- `--use_random_states` - Включает режим использования случайных начальных состояний
- `--random_state_min_depletion` - Минимальное значение степени истощения (0.0 = начало разработки)
- `--random_state_max_depletion` - Максимальное значение степени истощения (1.0 = полное истощение)
- `--random_state_probability` - Вероятность использования случайных состояний на каждом глобальном шаге (0-1)
- `--use_realistic_ranges` - Использовать реалистичные ограничения для параметров (по умолчанию включено)

Важно: Случайные начальные состояния применяются только в начале эпизода, а не на каждом шаге симуляции. Это позволяет модели изучать последовательность взаимосвязанных действий в рамках одного эпизода разработки скважины, но с разных стадий истощения пласта.

При включенной опции `--use_realistic_ranges` генерируются более правдоподобные состояния скважин:
- Давление пласта снижается нелинейно с истощением
- Степень открытия штуцера выбирается в зависимости от стадии разработки
- Дебит скважины рассчитывается с учетом взаимного влияния скважин (для многоскважинных систем)
- Применяются разумные ограничения на минимальное и максимальное истощение (обычно от 1% до 85%)

#### Обучение для многоскважинной системы
```bash
python -m grpo.main --multi_well --n_wells 3 --interaction_strength 0.2 --shared_reservoir --forecast_days 1 --simulation_max_time 365 --kl_weight 0.02 --lr 1e-5 --total_steps 1000 --rollouts_per_step 16 --train_batch_size 8 --wandb
```

### Основные параметры

Скрипт поддерживает множество параметров для настройки процесса обучения:

```
--run_name               Пользовательское имя запуска для логирования
--log_dir                Корневая директория для логов
--wandb                  Использовать WandB для логирования
--wandb_project          Имя проекта WandB
--seed                   Зерно случайности (по умолчанию: 42)
--device_index           Индекс устройства CUDA (по умолчанию: 0)
--model_name             Имя или путь к модели (по умолчанию: "Qwen/Qwen2.5-3B-Instruct")
--checkpoint_path        Путь для сохранения чекпоинтов
--checkpoint_interval    Сохранять чекпоинт каждые N глобальных шагов
--total_steps            Общее количество шагов оптимизации
--rollouts_per_step      Количество эпизодов симуляции на каждый глобальный шаг
--multi_well             Использовать многоскважинный симулятор вместо одиночной скважины
--initial_pressure       Начальное пластовое давление (атм)
--productivity_index     Индекс продуктивности (м3/день/атм)
--total_volume           Общий объем резервуара (м3)
--forecast_days          Количество дней для прогноза на каждом шаге

# Параметры случайных начальных состояний
--use_random_states              Включить обучение из случайных состояний скважины
--random_state_min_depletion     Минимальная степень истощения для случайных состояний (0-1)
--random_state_max_depletion     Максимальная степень истощения для случайных состояний (0-1)
--random_state_probability       Вероятность использования случайных состояний на каждом глобальном шаге
```

## Текущее состояние

Проект в настоящее время предоставляет полностью функциональные реализации сценариев оптимизации как для одиночных, так и для многоскважинных систем. Сценарий с одиночной скважиной служит более простой отправной точкой и доказательством концепции, в то время как реализация многоскважинной системы учитывает более сложную динамику резервуара с взаимодействием между скважинами.

## Рабочий процесс

1. **Среда симуляции**: Система моделирует поведение нефтяных скважин, включая изменения давления, дебиты и накопленную добычу.
2. **Взаимодействие с LLM**: Языковая модель получает текущее состояние и историю, затем принимает решение об оптимальном открытии штуцера.
3. **Обучение с подкреплением**: Модель обучается на основе наград от результатов добычи нефти.
4. **Оценка**: Производительность обученной модели оценивается на расширенных периодах симуляции.

## Лицензия

Этот проект предоставляется как исследовательское программное обеспечение.

## Цитирование

Если вы используете этот проект в своих исследованиях, пожалуйста, цитируйте:

```
@software{llm_oil_production,
  author = {researchim},
  title = {LLM for Oil Production Optimization},
  year = {2025},
  url = {https://github.com/yourusername/re-oil-production-llm}
}
``` 