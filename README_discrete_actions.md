# Система дискретных действий для управления нефтяной скважиной

## Обзор

Данная система позволяет LLM выбирать один из 10 вариантов открытия штуцера (числа от 1 до 10), соответствующих значениям `[0.1, 0.2, ..., 1.0]` вместо непрерывных значений от 0 до 1 с тегами `<parameter>`.

## Реализованные изменения

1. Добавлена константа `DISCRETE_ACTIONS` в файл `grpo/utils.py` со списком значений `[0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]`
2. Обновлена функция `parse_llm_action` для распознавания чисел от 1 до 10
3. Модифицированы симуляторы для сохранения последнего действия (`last_action`)
4. Обновлена функция `format_state` для отображения предыдущего действия в интерфейсе пользователя
5. Изменены все шаблоны промптов для работы с дискретными действиями
6. Обновлена функция `parse_llm_action` в `parallel_simulator.py` для совместимости с новым форматом

## Обратная совместимость

Для обеспечения плавного перехода, была добавлена обратная совместимость со старым форматом (теги `<parameter>`). Система:

1. Распознает старый формат с тегами `<parameter>`
2. Ищет ближайшее дискретное значение к указанному в тегах
3. Преобразует его в соответствующий индекс из списка `DISCRETE_ACTIONS`
4. Применяет действие, но с пониженной наградой за формат

## Распознаваемые форматы ответов

Система распознает следующие форматы ответов LLM:

1. **Одиночное число** (наиболее предпочтительно):
   ```
   5
   ```

2. **Текстовое описание выбора**:
   ```
   вариант 7
   выбираю 3
   ```

3. **Прямое указание значения штуцера**:
   ```
   0.5
   0.9
   ```

4. **Обратная совместимость (старый формат)**:
   ```
   <parameter>0.65</parameter>
   ```

## Аргументы командной строки

Для активации системы дискретных действий необходимо передать аргумент командной строки `--use_discrete_actions` в скрипты запуска:

```bash
python experiments/run_single_well_grpo.py --model_name "Qwen/Qwen2.5-3B-Instruct" --use_discrete_actions
```

или

```bash
python experiments/run_multi_well_grpo.py --model_name "Qwen/Qwen2.5-3B-Instruct" --use_discrete_actions --n_wells 3
```

## Тестирование

Для проверки работоспособности системы были созданы и успешно прошли два тестовых скрипта:

1. `test_discrete_actions.py` - тестирует распознавание различных форматов ответов
2. `test_command_line_args.py` - проверяет корректность обработки аргумента командной строки

## Известные ограничения

1. В текущей реализации система автоматически преобразует числа 1-10 в соответствующие значения из списка `DISCRETE_ACTIONS`.
2. При использовании старого формата с тегами `<parameter>` применяется пониженная награда за формат. 